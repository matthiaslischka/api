stages:
  - build
  - deploy

# Inspired by: https://www.testcontainers.org/ci/ci.html#gitlab
build_rest-api:
  image: docker:latest
  stage: build
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
  script: docker run -t --rm -v /var/run/docker.sock:/var/run/docker.sock -v "$(pwd)":"$(pwd)" -w "$(pwd)" -u 0:0 gradle:4.1 ./gradlew clean build
  artifacts:
    when: always
    paths:
      - 'rest-api/build/distributions/*.zip'
      - '*/build/reports/*'

deploy_on_development:
  stage: deploy
  script:
    - .aws/deploy api-prod
  only:
    - master
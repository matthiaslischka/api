image: registry.gitlab.com/nobt-io-public/api-build-image:2.1.0

stages:
  - build
  - deploy

build_rest-api:
  stage: build
  services:
    - postgres:9
  variables:
    DATABASE_CONNECTION_STRING: 'jdbc:postgresql://postgres:password@postgres:5432/postgres'
    PORT: '18080'
    MIGRATE_DATABASE_ON_STARTUP: 'true'
    USE_IN_MEMORY_DATABASE: 'false'
  script:
    - ./gradlew clean
    - ./gradlew test
    - ./gradlew integrationTest -Dorg.gradle.parallel=false # MUST NOT run integration tests in parallel
    - ./gradlew :rest-api:distZip
  artifacts:
    when: always
    paths:
      - 'rest-api/build/distributions/*.zip'
      - '*/build/reports/*'

deploy_on_development:
  stage: deploy
  script:
    - .aws/deploy api-prod
  only:
    - master
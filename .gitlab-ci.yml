image: registry.gitlab.com/nobt-io-public/api-build-image:1.0.3

stages:
  - build
  - deploy

build_rest-api:
  stage: build
  services:
    - postgres:9
  variables:
    DATABASE_CONNECTION_STRING: 'jdbc:postgresql://postgres:password@postgres:5432/postgres'
  script:
    - ./gradlew clean
    - ./gradlew test
    - ./gradlew integrationTest -Dorg.gradle.parallel=false # MUST NOT run integration tests in parallel
    - ./gradlew :rest-api:distZip
  artifacts:
    when: always
    paths:
      - 'rest-api/build/distributions/*.zip'
      - '*/build/reports/*'

deploy_on_development:
  stage: deploy
  before_script:
    - .cf/login development
    - .cf/ensureDatabase
  script:
    - .cf/push nobt-io-dev
  after_script:
    - .cf/updateDatabaseConfig
  environment: development
  only:
    - master

deploy_on_beta:
  stage: deploy
  before_script:
    - .cf/login beta
    - .cf/ensureDatabase
  script:
    - .cf/push nobt-io-beta
  after_script:
    - .cf/updateDatabaseConfig
  environment: beta
  when: manual

deploy_on_production:
  stage: deploy
    - .cf/login production
    - .cf/ensureDatabase
  script:
    - .cf/push nobt-io
  after_script:
    - .cf/updateDatabaseConfig
  environment: production
  when: manual